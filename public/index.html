<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fast Mini Chat</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="loginBox">
  <h2>Fast Mini Chat</h2>

  <input id="username" placeholder="Nome">
  <input id="password" type="password" placeholder="Senha">

  <br>
  <button onclick="register()">Criar conta</button>
  <button onclick="login()">Entrar</button>

  <p id="status"></p>
</div>

<div id="chatBox" style="display:none;">
  <h3>Seu ID: <span id="myIdSpan"></span></h3>

  <input id="targetId" placeholder="ID do amigo">

  <div id="messages"></div>

  <input id="messageInput" placeholder="Mensagem">
  <button onclick="sendMessage()">Enviar</button>
</div>

<script>
const loginBox = document.getElementById("loginBox");
const chatBox = document.getElementById("chatBox");
const statusText = document.getElementById("status");
const myIdSpan = document.getElementById("myIdSpan");
const messages = document.getElementById("messages");

const username = document.getElementById("username");
const password = document.getElementById("password");
const targetId = document.getElementById("targetId");
const messageInput = document.getElementById("messageInput");

// WebSocket (funciona local e na Render)
const ws = new WebSocket(
  (location.protocol === "https:" ? "wss://" : "ws://") + location.host
);

let myId = null;

ws.onmessage = (event) => {
  const msg = JSON.parse(event.data);

  if (msg.type === "register-success") {
    statusText.innerText = "Conta criada! Seu ID: " + msg.id;
  }

  if (msg.type === "register-error") {
    statusText.innerText = "Nome já existe!";
  }

  if (msg.type === "login-success") {
    myId = msg.id;
    loginBox.style.display = "none";
    chatBox.style.display = "block";
    myIdSpan.innerText = myId;
  }

  if (msg.type === "login-error") {
    statusText.innerText = "Login inválido!";
  }

  if (msg.type === "private-message") {
    messages.innerHTML += `<p><b>${msg.from}:</b> ${msg.text}</p>`;
    messages.scrollTop = messages.scrollHeight;
  }
};

function register(){
  if (!username.value || !password.value) {
    statusText.innerText = "Preencha nome e senha!";
    return;
  }

  ws.send(JSON.stringify({
    type:"register",
    username: username.value,
    password: password.value
  }));
}

function login(){
  ws.send(JSON.stringify({
    type:"login",
    username: username.value,
    password: password.value
  }));
}

function sendMessage(){
  if (!targetId.value || !messageInput.value) return;

  ws.send(JSON.stringify({
    type:"private-message",
    to: targetId.value,
    text: messageInput.value
  }));

  // Mostra sua própria mensagem na tela
  messages.innerHTML += `<p><b>Você:</b> ${messageInput.value}</p>`;
  messages.scrollTop = messages.scrollHeight;

  messageInput.value = "";
}
</script>

</body>
</html>
